{% extends "basic/layout.html" %}

{% block title %}Calendario{% endblock %}

{# Se nel tuo basic/layout.html esiste un block navbar_links, questo evita menu duplicati in navbar #}
{% block navbar_links %}{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
  <style>
    .calendar-shell{
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      padding: 16px;
      background: var(--bs-body-bg);
      box-shadow: 0 .5rem 1.25rem rgba(0,0,0,.06);
      overflow: hidden;
    }
    .slot-btn{
      border-radius: 999px;
      font-weight: 700;
      white-space: nowrap;
    }
    .day-meta{
      font-size: .9rem;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row g-4">

    <!-- Contenuto -->
    <main class="col-12 col-lg-9 col-xl-10">

      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
        <div>
          <h1 class="h3 mb-1">üìÖ Prenota uno slot</h1>
          <div class="text-muted">Scegli un giorno e clicca un orario libero (da domani in poi).</div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <span class="badge text-bg-success">Disponibile</span>
          <span class="badge text-bg-secondary">Oggi non prenotabile</span>
        </div>
      </div>

      <!-- Agenda slot -->
      <section class="calendar-shell">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
          <div class="d-flex align-items-center gap-2">
            <input id="searchDay" type="text" class="form-control form-control-sm" style="max-width: 260px;"
                   placeholder="Filtra (es. luned√¨, 20, gennaio)">
            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearSearch()">Reset</button>
          </div>

          <div class="btn-group">
            <button class="btn btn-outline-primary btn-sm" type="button" onclick="loadSlots(7)">7 giorni</button>
            <button class="btn btn-outline-primary btn-sm" type="button" onclick="loadSlots(14)">14 giorni</button>
            <button class="btn btn-outline-primary btn-sm" type="button" onclick="loadSlots(30)">30 giorni</button>
          </div>
        </div>

        <div id="slotLoading" class="d-none py-4 text-center">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <div class="mt-2 text-muted">Carico gli slot‚Ä¶</div>
        </div>

        <div id="slotEmpty" class="d-none text-muted py-4 text-center">
          Nessuno slot disponibile nel periodo selezionato.
        </div>

        <div id="slotList" class="accordion"></div>
      </section>

      <!-- Toast -->
      <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toastPrenotazione" class="toast align-items-center text-bg-success border-0"
             role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div id="toastPrenotazioneText" class="toast-body">Prenotazione effettuata con successo! üéâ</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Chiudi"></button>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- Modale prenotazione -->
<div class="modal fade" id="modalePrenotazione" tabindex="-1" aria-labelledby="modalePrenotazioneLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalePrenotazioneLabel">Conferma Prenotazione</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>

      <div class="modal-body">
        <div class="p-3 rounded bg-body-tertiary mb-3">
          <div><strong>Quando:</strong> <span id="modalQuando"></span></div>
          <div><strong>Orario:</strong> <span id="modalOrario"></span></div>
        </div>

        <form id="formPrenotazioneAvanzata" enctype="multipart/form-data">
          <input type="hidden" id="hiddenSlotId" name="slot_id">

          <div class="mb-3">
            <label for="selectServizio" class="form-label">Servizio</label>
            <select class="form-select" id="selectServizio" name="servizio_id" required>
              {% for servizio in servizi %}
              <option value="{{ servizio.id }}">{{ servizio.Servizio }} - ‚Ç¨{{ servizio.Prezzo }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="messaggioUtente" class="form-label">Messaggio (opzionale)</label>
            <textarea class="form-control" id="messaggioUtente" name="messaggio" rows="3"
              placeholder="Note sulla prenotazione, richieste specifiche, ecc."></textarea>
          </div>

          <div class="mb-3">
            <label for="fileUpload" class="form-label">Carica immagini (opzionale)</label>
            <input class="form-control" type="file" id="fileUpload" name="immagini" multiple>
          </div>
        </form>
      </div>

      <div class="modal-footer justify-content-between">
        <small class="text-muted">‚ö†Ô∏è Non √® possibile prenotare oggi o per giorni passati.</small>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annulla</button>
          <button id="btnConferma" type="button" class="btn btn-success" onclick="confermaPrenotazioneAvanzata()">
            Conferma
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let CURRENT_SLOTS = [];
let CURRENT_RANGE_DAYS = 14;

function toISODate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function formatDayLabel(isoDate){
  const d = new Date(isoDate + "T00:00:00");
  return d.toLocaleDateString('it-IT', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
}

function openBookingModal(slot){
  const start = new Date(`${slot.data}T${slot.ora_inizio}`);
  const end = new Date(`${slot.data}T${slot.ora_fine}`);

  document.getElementById('modalQuando').textContent =
    start.toLocaleDateString('it-IT', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  document.getElementById('modalOrario').textContent =
    `${start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ‚Äì ${end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

  document.getElementById('hiddenSlotId').value = slot.id;

  new bootstrap.Modal(document.getElementById('modalePrenotazione')).show();
}

function clearSearch(){
  document.getElementById("searchDay").value = "";
  renderSlots(CURRENT_SLOTS);
}

function matchesSearch(dayLabel, isoDate){
  const q = document.getElementById("searchDay").value.trim().toLowerCase();
  if(!q) return true;
  return (dayLabel.toLowerCase().includes(q) || isoDate.includes(q));
}

async function loadSlots(days){
  CURRENT_RANGE_DAYS = days;

  const loading = document.getElementById('slotLoading');
  const empty = document.getElementById('slotEmpty');
  const slotList = document.getElementById('slotList');

  loading.classList.remove('d-none');
  empty.classList.add('d-none');
  slotList.innerHTML = "";

  const start = new Date();
  start.setDate(start.getDate() + 1); // da domani
  start.setHours(0,0,0,0);

  const end = new Date(start);
  end.setDate(end.getDate() + days);

  try{
    const res = await fetch(`/api/slot?start=${toISODate(start)}&end=${toISODate(end)}`);
    const data = await res.json();

    // sicurezza: se arrivano roba di oggi/passato, filtriamo comunque
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(0,0,0,0);

    CURRENT_SLOTS = data.filter(s => new Date(`${s.data}T00:00:00`) >= tomorrow);
    renderSlots(CURRENT_SLOTS);

  } catch(e){
    console.error(e);
    slotList.innerHTML = `<div class="text-danger py-3">Errore nel caricamento degli slot.</div>`;
  } finally {
    loading.classList.add('d-none');
  }
}

function renderSlots(slots){
  const empty = document.getElementById('slotEmpty');
  const slotList = document.getElementById('slotList');

  slotList.innerHTML = "";

  // raggruppa per data
  const grouped = {};
  for(const s of slots){
    if(!grouped[s.data]) grouped[s.data] = [];
    grouped[s.data].push(s);
  }

  const dates = Object.keys(grouped).sort();

  if(dates.length === 0){
    empty.classList.remove('d-none');
    return;
  }
  empty.classList.add('d-none');

  let accIndex = 0;

  for(const date of dates){
    const dayLabel = formatDayLabel(date);
    if(!matchesSearch(dayLabel, date)) continue;

    const items = grouped[date].sort((a,b)=>a.ora_inizio.localeCompare(b.ora_inizio));
    const buttons = items.map(s => {
      const label = `${s.ora_inizio.slice(0,5)}‚Äì${s.ora_fine.slice(0,5)}`;
      return `
        <button class="btn btn-outline-success btn-sm slot-btn"
                type="button"
                data-slot-id="${s.id}"
                data-date="${s.data}"
                data-start="${s.ora_inizio}"
                data-end="${s.ora_fine}">
          ${label}
        </button>
      `;
    }).join("");

    const idx = accIndex++;
    const open = idx === 0 ? "show" : "";
    const collapsed = idx === 0 ? "" : "collapsed";
    const aria = idx === 0 ? "true" : "false";

    slotList.insertAdjacentHTML("beforeend", `
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button ${collapsed}" type="button" data-bs-toggle="collapse" data-bs-target="#day_${idx}" aria-expanded="${aria}">
            <div class="d-flex flex-column">
              <div class="text-capitalize">${dayLabel}</div>
              <div class="text-muted day-meta">${items.length} slot</div>
            </div>
          </button>
        </h2>
        <div id="day_${idx}" class="accordion-collapse collapse ${open}">
          <div class="accordion-body d-flex flex-wrap gap-2">
            ${buttons}
          </div>
        </div>
      </div>
    `);
  }

  // bind click
  document.querySelectorAll(".slot-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const slot = {
        id: btn.dataset.slotId,
        data: btn.dataset.date,
        ora_inizio: btn.dataset.start,
        ora_fine: btn.dataset.end
      };
      openBookingModal(slot);
    });
  });
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("searchDay").addEventListener("input", () => renderSlots(CURRENT_SLOTS));
  loadSlots(14);
});

async function confermaPrenotazioneAvanzata() {
  const btn = document.getElementById("btnConferma");
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Invio...`;

  try{
    const form = document.getElementById('formPrenotazioneAvanzata');
    const formData = new FormData(form);

    const fileInput = document.getElementById('fileUpload');
    for (let i = 0; i < fileInput.files.length; i++) {
      formData.append('immagini', fileInput.files[i]);
    }

    const response = await fetch('/api/prenota_slot_avanzato', { method: 'POST', body: formData });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error || "Errore nella prenotazione");
    }

    const result = await response.json();

    bootstrap.Modal.getInstance(document.getElementById('modalePrenotazione')).hide();

    document.getElementById('toastPrenotazioneText').textContent =
      result.message || "Prenotazione effettuata! üéâ";

    new bootstrap.Toast(document.getElementById('toastPrenotazione'), { delay: 2200 }).show();

    setTimeout(() => window.location.href = "/utente/prenotazioni", 2200);

  } catch (error){
    alert("Errore nella prenotazione: " + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = "Conferma";
  }
}
</script>
{% endblock %}
